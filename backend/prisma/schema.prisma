generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User-related models
model User {
  id            String        @id @default(cuid())
  name          String?
  email         String        @unique
  emailVerified DateTime?
  password      String? // not for OAuth Users
  image         String?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  accounts      Account[]
  UserInfo      UserInfo[]
  UserSettings  UserSettings?


  @@index([email])

  // Project-related
  projectMembers  ProjectMember[] // Link to projects
  createdProjects Project[]       @relation("ProjectCreator")

  // Task-related
  createdTasks  Task[] @relation("TaskCreator")
  assignedTasks Task[] @relation("TaskAssignee")
  assignedSubtasks Subtask[]

  // Chat and comments
  chatMessages ChatMessage[]

  // File-related
  uploadedFiles File[] @relation("FileUploader")

  sentMessages     DirectMessage[] @relation("MessageSender")
  receivedMessages DirectMessage[] @relation("MessageReceiver")
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model UserInfo {
  id         String   @id @default(cuid())
  userId     String   @unique
  bio        String?
  skills     String?
  jobTitle   String?
  department String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model UserSettings {
  id     String @id @default(cuid())
  userId String @unique

  // Collaboration Preferences
  autoAcceptTaskAssignments   Boolean @default(true)
  taskReminderNotifications   Boolean @default(true)
  showDueDatesInLocalTimezone Boolean @default(true)

  // Email Notifications
  emailProjectInvitations   Boolean @default(true)
  emailTaskAssignments      Boolean @default(true)
  emailTaskDueDateReminders Boolean @default(true)
  emailComments             Boolean @default(true)

  // In-App Notifications
  inAppProjectUpdates Boolean @default(true)
  inAppRoleChanges    Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  id        String
  email     String
  code      String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@unique([id, code])
}

model PasswordResetToken {
  id        String   @id @default(uuid())
  email     String
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())
}

model DeleteAccountToken {
  id        String   @id @default(uuid())
  email     String
  code      String
  expiresAt DateTime
  createdAt DateTime @default(now())
}

// Project-related models
model Project {
  id          String        @id @default(cuid())
  name        String
  description String?
  creatorId   String
  status      ProjectStatus @default(IN_PROGRESS)
  dueDate     DateTime?
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  @@index([creatorId])

  // Relations
  creator      User                @relation("ProjectCreator", fields: [creatorId], references: [id])
  members      ProjectMember[]
  tasks        Task[]
  projectFiles File[]              @relation("ProjectFiles")
  invitations  ProjectInvitation[]
  chatMessages ChatMessage[]
}

enum ProjectStatus {
  IN_PROGRESS
  AT_RISK
  COMPLETED
}

model ProjectMember {
  id        String      @id @default(cuid())
  projectId String
  userId    String
  role      ProjectRole @default(MEMBER)
  joinedAt  DateTime    @default(now())

  @@index([userId])
  @@index([projectId, role])

  // Relations
  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([projectId, userId])
}

enum ProjectRole {
  ADMIN
  EDITOR
  MEMBER
}

model ProjectInvitation {
  id        String      @id @default(cuid())
  projectId String
  email     String
  role      ProjectRole @default(MEMBER)
  token     String      @unique
  expiresAt DateTime
  createdAt DateTime    @default(now())

  // Relations
  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@unique([projectId, email])
}

// Task-related models
model Task {
  id             String       @id @default(cuid())
  title          String
  description    String?
  projectId      String
  creatorId      String
  assigneeId     String?
  status         TaskStatus   @default(TODO)
  dueDate        DateTime?
  priority       TaskPriority @default(MEDIUM)
  completionNote String?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  @@index([projectId]) 
  @@index([assigneeId])
  @@index([status])
  @@index([dueDate])

  // Relations
  project      Project       @relation(fields: [projectId], references: [id], onDelete: Cascade)
  creator      User          @relation("TaskCreator", fields: [creatorId], references: [id])
  assignee     User?         @relation("TaskAssignee", fields: [assigneeId], references: [id], onDelete: SetNull)
  taskFiles    File[]        @relation("TaskFiles")
  subtasks     Subtask[]
  sourceLinks  TaskLink[]    @relation("SourceTask")
  targetLinks  TaskLink[]    @relation("TargetTask")
}

model Subtask {
  id         String       @id @default(cuid())
  taskId     String
  name       String
  status     TaskStatus   @default(TODO)
  priority   TaskPriority @default(MEDIUM)
  assigneeId String?
  createdAt  DateTime     @default(now())
  updatedAt  DateTime     @updatedAt

  @@index([taskId])
  @@index([assigneeId])

  // Relations
  task     Task  @relation(fields: [taskId], references: [id], onDelete: Cascade)
  assignee User? @relation(fields: [assigneeId], references: [id], onDelete: SetNull)
}

model TaskLink {
  id           String           @id @default(cuid())
  sourceTaskId String
  targetTaskId String
  relationship TaskRelationship
  createdAt    DateTime         @default(now())

  @@index([sourceTaskId])
  @@index([targetTaskId])

  // Relations
  sourceTask Task @relation("SourceTask", fields: [sourceTaskId], references: [id], onDelete: Cascade)
  targetTask Task @relation("TargetTask", fields: [targetTaskId], references: [id], onDelete: Cascade)

  @@unique([sourceTaskId, targetTaskId, relationship])
}

enum TaskStatus {
  TODO
  IN_PROGRESS
  DONE
}

enum TaskPriority {
  LOW
  MEDIUM
  HIGH
}

enum TaskRelationship {
  BLOCKS
  BLOCKED_BY
}

// Chat system
model ChatMessage {
  id           String   @id @default(cuid())
  content      String
  projectId    String
  userId       String
  mentionsJson String? // JSON string of mentions (users, projects, tasks)
  createdAt    DateTime @default(now())

  @@index([projectId])
  @@index([userId])

  // Relations
  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// File management
model File {
  id                String   @id @default(cuid())
  name              String
  url               String
  size              Int // in bytes
  type              String // MIME type
  uploaderId        String
  taskId            String? // Optional: if file is associated with a task
  projectId         String // All files belong to a project
  isTaskDeliverable Boolean  @default(false) // Whether this is a deliverable for task completion
  createdAt         DateTime @default(now())

  @@index([projectId])
  @@index([taskId])
  @@index([uploaderId])

  // Relations
  project  Project @relation("ProjectFiles", fields: [projectId], references: [id], onDelete: Cascade)
  task     Task?   @relation("TaskFiles", fields: [taskId], references: [id], onDelete: SetNull)
  uploader User    @relation("FileUploader", fields: [uploaderId], references: [id], onDelete: Cascade)
}

// Direct messaging
model DirectMessage {
  id        String   @id @default(cuid())
  content   String
  senderId  String
  receiverId String
  read      Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([senderId])
  @@index([receiverId])

  // Relations
  sender    User     @relation("MessageSender", fields: [senderId], references: [id], onDelete: Cascade)
  receiver  User     @relation("MessageReceiver", fields: [receiverId], references: [id], onDelete: Cascade)
}

// Reminder tracking với Queue System
model ReminderLog {
  id           String    @id @default(cuid())
  entityType   String    // "task" hoặc "project"
  entityId     String    // ID của task hoặc project
  threshold    Int       // Thời gian trước deadline (phút): 1440=24h, 720=12h, 180=3h, 60=1h
  fireAt       DateTime  // Thời điểm cần gửi reminder
  sentAt       DateTime? // NULL = chưa gửi, NOT NULL = đã gửi
  jobId        String?   // BullMQ job ID để hủy job nếu cần
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  @@index([entityType, entityId, threshold])
  @@index([fireAt, sentAt]) // Cho backfill query
  @@index([jobId])
  @@unique([entityType, entityId, threshold]) // Mỗi entity chỉ có 1 reminder cho mỗi threshold
}

